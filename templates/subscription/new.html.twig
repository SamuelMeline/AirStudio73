{% extends 'base.html.twig' %}

{% block body %}
	<div class="container">
		<div class="card shadow-sm">
			<h1>Sélectionner votre forfait</h1>
			<div
				class="card-body">

				<!-- Affichage des messages flash -->
				{% for label, messages in app.flashes %}
					<div class="alert alert-{{ label }}">
						{% for message in messages %}
							{{ message }}
						{% endfor %}
					</div>
				{% endfor %}

				<!-- Début du formulaire -->
				{{ form_start(form) }}

				<!-- Sélection du type de forfait -->
				<div class="form-group">
					{{ form_label(form.type, null, {'label_attr': {'class': 'form-label'}}) }}
					{{ form_widget(form.type, {'attr': {'class': 'form-control', 'onchange': 'this.form.submit();'}}) }}
				</div>

				<!-- Sélection du plan, affiché seulement si défini -->
				{% if form.plan is defined %}
					<div class="form-group">
						{{ form_label(form.plan, null, {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(form.plan, {'attr': {'class': 'form-control', 'onchange': 'updatePaymentOptions(this.value); checkPlanExpiry(this.value); fetchRemainingCredits(this.value);'}}) }}
					</div>
					<!-- Affichage des crédits restants -->
					<div class="form-group">
						<p id="remaining-credits">Crédits restants :
							<span id="credits-value">-</span>
						</p>
					</div>
				{% endif %}

				<!-- Nombre de paiements (sera mis à jour dynamiquement) -->
				<div class="form-group">
					<label for="payment-options">Nombre de paiements</label>
					<select id="payment-options" class="form-control">
						<option value="">Sélectionnez un forfait d'abord</option>
					</select>
				</div>

				<!-- Champ de code promotionnel -->
				<div class="form-group">
					{{ form_label(form.promoCode, null, {'label_attr': {'class': 'form-label'}}) }}
					{{ form_widget(form.promoCode, {'attr': {'class': 'form-control'}}) }}
				</div>

				<!-- Autres champs du formulaire -->
				{{ form_rest(form) }}

				<!-- Bouton de soumission -->
				<button type="submit" class="btn btn-general mt-2">Réserver et payer</button>

				{{ form_end(form) }}

				<!-- Lien pour ajouter un nouveau forfait, visible seulement pour l'administrateur -->
				{% if is_granted('ROLE_ADMIN') %}
					<div class="mt-3">
						<a href="{{ path('plan_new') }}" class="btn reserve-btn">Ajouter un nouveau forfait</a>
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	<script>
		function updatePaymentOptions(planId) { // Envoie une requête AJAX pour obtenir les options de paiement
fetch('{{ path('get_payment_options') }}', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-CSRF-Token': '{{ csrf_token('get_payment_options') }}'
},
body: JSON.stringify(
{planId: planId}
)
}).then(response => response.json()).then(data => {
const paymentSelect = document.getElementById('payment-options');
paymentSelect.innerHTML = ''; // Réinitialiser les options

if (data.paymentOptions) {
data.paymentOptions.forEach(option => {
const opt = document.createElement('option');
opt.value = option.value;
opt.text = option.label;
paymentSelect.appendChild(opt);
});
} else {
paymentSelect.innerHTML = '<option value="">Aucune option disponible</option>';
alert(data.error);
}
}).catch(error => {
console.error('Erreur lors de la récupération des options de paiement:', error);
});
}
	</script>
	<script>
		function checkPlanExpiry(planId) { // Envoie une requête AJAX au serveur pour vérifier l'expiration du forfait
fetch('{{ path('check_plan_expiry') }}', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-CSRF-Token': '{{ csrf_token('check_plan_expiry') }}'
},
body: JSON.stringify(
{planId: planId}
)
}).then(response => response.json()).then(data => {
if (data.warning) {
alert(data.warning);
}
});
}
	</script>
	<script>
		function fetchRemainingCredits(planId) { // Envoie une requête AJAX pour obtenir les crédits restants
fetch('{{ path('fetch_remaining_credits') }}', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-CSRF-Token': '{{ csrf_token('fetch_remaining_credits') }}'
},
body: JSON.stringify(
{planId: planId}
)
}).then(response => response.json()).then(data => {
if (data.remainingCredits !== undefined) {
document.getElementById('credits-value').textContent = data.remainingCredits;
} else if (data.error) {
alert(data.error);
}
});
}
	</script>
{% endblock %}
